<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>roz.ai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Basic styling */
        body { font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; position: relative; }

        /* roz.ai Theme Colors from JSON */
        :root {
            --rz-toolbar: rgba(129, 90, 118, 0.36); --rz-toolbar-opaque: rgb(129, 90, 118); /* #815a76 */ --rz-toolbar-text: rgb(176, 146, 87); /* #b09257 */ --rz-frame: rgb(48, 48, 63); /* #30303f */ --rz-tab-background-text: rgb(150, 146, 143); /* #96928f */ --rz-toolbar-field: rgb(61, 50, 61); /* #3d323d */ --rz-toolbar-field-text: rgb(255, 250, 241); /* #fffaf1 */ --rz-tab-line: rgb(174, 163, 142); /* #aea38e */ --rz-popup: rgb(224, 229, 236); /* #e0e5ec */ --rz-popup-text: rgb(33, 34, 72); /* #212248 */ --rz-tab-loading: rgb(174, 163, 142); --rz-sidebar-bg: var(--rz-toolbar-field); --rz-sidebar-text: var(--rz-toolbar-text); --rz-sidebar-border: var(--rz-toolbar-text); --rz-sidebar-hover-bg: var(--rz-frame); --rz-sidebar-active-bg: var(--rz-toolbar-text); --rz-sidebar-active-text: var(--rz-toolbar-field); --rz-button-primary-bg: var(--rz-toolbar-text); --rz-button-primary-text: var(--rz-toolbar-field); --rz-button-primary-hover-bg: var(--rz-tab-line); --rz-button-secondary-bg: var(--rz-frame); --rz-button-secondary-text: var(--rz-toolbar-text); --rz-button-secondary-hover-bg: var(--rz-toolbar-opaque); --rz-button-outline-border: var(--rz-toolbar-text); --rz-button-outline-text: var(--rz-toolbar-text); --rz-button-outline-hover-bg: var(--rz-frame); --rz-button-outline-hover-text: var(--rz-toolbar-text); --rz-user-message-bg: var(--rz-popup); --rz-user-message-text: var(--rz-popup-text); --rz-assistant-message-bg: #e5e7eb; --rz-assistant-message-text: #1f2937; --rz-tag-bg: var(--rz-popup); --rz-tag-text: var(--rz-popup-text); --rz-tag-border: var(--rz-tab-line); --rz-modal-bg: var(--rz-popup); --rz-modal-text: var(--rz-popup-text); --rz-modal-header-text: var(--rz-frame); --rz-main-bg: var(--rz-popup); --rz-chatbox-bg: #ffffff; --rz-input-bg: var(--rz-popup); --rz-input-text-bg: #ffffff; --rz-input-border: var(--rz-tab-line); --rz-input-text: var(--rz-popup-text); --rz-input-focus-ring: var(--rz-toolbar-text); --rz-header-bg: var(--rz-frame); --rz-header-text: var(--rz-toolbar-field-text); --rz-status-bar-bg: var(--rz-frame); --rz-status-bar-text: var(--rz-tab-background-text);
        }

        /* Left Sidebar (Chats) */
        #sidebar { width: 320px; background-color: var(--rz-sidebar-bg); border-right: 1px solid var(--rz-sidebar-border); color: var(--rz-sidebar-text); padding: 1rem; display: flex; flex-direction: column; flex-shrink: 0; transition: width 0.3s ease-in-out, padding 0.3s ease-in-out, border 0.3s ease-in-out; overflow-x: hidden; }
        body.sidebar-collapsed #sidebar { width: 0; padding-left: 0; padding-right: 0; border-right-width: 0; }

        /* Right Sidebar (Plugins) */
        #plugins-sidebar { width: 300px; background-color: var(--rz-sidebar-bg); border-left: 1px solid var(--rz-sidebar-border); color: var(--rz-sidebar-text); padding: 1rem; display: flex; flex-direction: column; flex-shrink: 0; transition: width 0.3s ease-in-out, padding 0.3s ease-in-out, border 0.3s ease-in-out; overflow-x: hidden; }
        body.plugins-collapsed #plugins-sidebar { width: 0; padding-left: 0; padding-right: 0; border-left-width: 0; }

        /* Main Content Area */
        #main-content { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; background-color: var(--rz-main-bg); min-width: 0; }
        #main-header { padding: 0.5rem 1rem; border-bottom: 1px solid var(--rz-frame); background-color: var(--rz-header-bg); color: var(--rz-header-text); display: flex; align-items: center; justify-content: center; gap: 0.5rem; flex-shrink: 0; }
        #model-selector { font-size: 0.875rem; padding: 0.25rem 0.5rem; border-radius: 0.375rem; border: 1px solid var(--rz-tab-line); background-color: var(--rz-toolbar-field); color: var(--rz-toolbar-field-text); }
        #model-selector option { background-color: var(--rz-toolbar-field); color: var(--rz-toolbar-field-text); }

        #chat-area { padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; min-height: 0; }
        #chatbox { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.5rem; background-color: var(--rz-chatbox-bg); }
        #input-area { padding: 0 1rem 1rem 1rem; display: flex; flex-direction: column; gap: 0.5rem; border-top: 1px solid #d1d5db; padding-top: 1rem; flex-shrink: 0; background-color: var(--rz-input-bg); }
        #input-controls { display: flex; align-items: center; gap: 0.5rem; }
        #message-input { background-color: var(--rz-input-text-bg); border: 1px solid var(--rz-input-border); color: var(--rz-input-text); }
        #message-input::placeholder { color: var(--rz-tab-background-text); }
        #message-input:focus { outline: none; box-shadow: 0 0 0 2px var(--rz-input-focus-ring); border-color: var(--rz-input-focus-ring); }

        /* Selected Files Display Area */
        #selected-files-container { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem; max-height: 5em; overflow-y: auto; padding-bottom: 0.25rem;}
        .selected-file-tag { font-size: 0.75rem; color: var(--rz-tag-text); background-color: var(--rz-tag-bg); border: 1px solid var(--rz-tag-border); padding: 0.2rem 0.5rem; border-radius: 0.25rem; display: inline-flex; align-items: center; gap: 0.4rem; white-space: nowrap; }
        .selected-file-tag .file-type { font-size: 0.65rem; font-weight: 500; color: var(--rz-popup-text); background-color: white; padding: 0 0.25rem; border-radius: 0.125rem; }
        .selected-file-tag button { background: none; border: none; color: var(--rz-frame); cursor: pointer; padding: 0; line-height: 1; margin-left: 0.25rem; }
        .selected-file-tag button:hover { color: var(--rz-toolbar-opaque); }

        /* Sidebar Toggle Buttons */
        .toggle-btn { position: absolute; top: 0.75rem; z-index: 50; background-color: var(--rz-sidebar-bg); border: 1px solid var(--rz-sidebar-border); padding: 0.75rem 0.5rem; cursor: pointer; transition: left 0.3s ease-in-out, right 0.3s ease-in-out, background-color 0.2s; box-shadow: 0px 0px 5px rgba(0,0,0,0.1); }
        .toggle-btn i { color: var(--rz-sidebar-text); display: block; }
        .toggle-btn:hover { background-color: var(--rz-sidebar-hover-bg); }
        #sidebar-toggle-btn { left: 320px; border-left: none; border-top-right-radius: 0.375rem; border-bottom-right-radius: 0.375rem; }
        body.sidebar-collapsed #sidebar-toggle-btn { left: 0px; border-left: 1px solid var(--rz-sidebar-border); border-right: none; border-top-left-radius: 0.375rem; border-bottom-left-radius: 0.375rem; border-top-right-radius: 0; border-bottom-right-radius: 0; }
        #plugins-toggle-btn { right: 300px; border-right: none; border-top-left-radius: 0.375rem; border-bottom-left-radius: 0.375rem; }
        body.plugins-collapsed #plugins-toggle-btn { right: 0px; border-right: 1px solid var(--rz-sidebar-border); border-left: none; border-top-right-radius: 0.375rem; border-bottom-right-radius: 0.375rem; border-top-left-radius: 0; border-bottom-left-radius: 0; }

        /* Message Styling */
        .message { padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 0.5rem; max-width: 85%; word-wrap: break-word; line-height: 1.5; }
        .user-msg { margin-left: auto; background-color: var(--rz-user-message-bg); color: var(--rz-user-message-text); }
        .assistant-msg { margin-right: auto; background-color: var(--rz-assistant-message-bg); color: var(--rz-assistant-message-text); }
        .error-msg { margin-right: auto; background-color: #fee2e2; color: #991b1b; font-style: italic; }
        .system-msg { text-align: center; font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem; white-space: pre-wrap; }
        .message pre { margin-top: 0.5rem; background-color: var(--rz-frame); color: var(--rz-toolbar-field-text); padding: 0.5rem; border-radius: 0.25rem; }
        /* Attachment Icon Styling */
        .attachment-icon {
            display: inline-flex; /* Changed from block */
            align-items: center;
            gap: 0.25rem;
            font-size: 0.8rem;
            color: inherit; /* Inherit color from message */
            background-color: rgba(0, 0, 0, 0.05);
            padding: 0.15rem 0.4rem;
            border-radius: 0.25rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            margin-right: 0.3rem; /* Space after icon block */
            margin-bottom: 0.2rem; /* Space below if wrapping */
            vertical-align: middle; /* Align with text */
        }
        .attachment-icon i { opacity: 0.8; }
        .attachment-icon.error-marker { color: #991b1b; background-color: rgba(254, 202, 202, 0.4); border-color: rgba(248, 113, 113, 0.5); }

        /* Scrollbar Styling */
        #chatbox::-webkit-scrollbar, #saved-chats-list::-webkit-scrollbar, #uploaded-files-list::-webkit-scrollbar, #selected-files-container::-webkit-scrollbar { width: 6px; height: 6px; }
        #chatbox::-webkit-scrollbar-track, #saved-chats-list::-webkit-scrollbar-track, #uploaded-files-list::-webkit-scrollbar-track, #selected-files-container::-webkit-scrollbar-track { background: var(--rz-popup); border-radius: 10px; }
        #chatbox::-webkit-scrollbar-thumb, #saved-chats-list::-webkit-scrollbar-thumb, #uploaded-files-list::-webkit-scrollbar-thumb, #selected-files-container::-webkit-scrollbar-thumb { background: var(--rz-tab-line); border-radius: 10px; }
        #chatbox::-webkit-scrollbar-thumb:hover, #saved-chats-list::-webkit-scrollbar-thumb:hover, #uploaded-files-list::-webkit-scrollbar-thumb:hover, #selected-files-container::-webkit-scrollbar-thumb:hover { background: var(--rz-toolbar-text); }

        /* Sidebar Specific Styling */
        .sidebar-section-container { flex-grow: 1; overflow-y: hidden; display: flex; flex-direction: column; min-height: 0; }
        .sidebar-list { flex-grow: 1; overflow-y: auto; margin-top: 0.5rem; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0.5rem; border-radius: 0.375rem; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; white-space: nowrap; color: var(--rz-sidebar-text); }
        .list-item:hover { background-color: var(--rz-sidebar-hover-bg); }
        .list-item.active { background-color: var(--rz-sidebar-active-bg); color: var(--rz-sidebar-active-text); font-weight: 500; }
        .list-item .filename { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; margin-right: 0.5rem; font-size: 0.85rem; }
        .list-item .filesize { font-size: 0.7rem; color: var(--rz-tab-background-text); flex-shrink: 0; margin-left: auto; padding-left: 0.5rem; }
        .delete-btn { background: none; border: none; color: var(--rz-toolbar-opaque); cursor: pointer; padding: 0.25rem; line-height: 1; opacity: 0.8; transition: opacity 0.2s, color 0.2s; margin-left: 0.5rem; flex-shrink: 0; }
        .delete-btn:hover { opacity: 1; color: var(--rz-toolbar-text); }
        .chat-name-input { border: 1px solid var(--rz-sidebar-border); border-radius: 0.375rem; padding: 0.3rem 0.5rem; width: 100%; background-color: var(--rz-frame); color: var(--rz-toolbar-field-text); }
        .chat-name-input::placeholder { color: var(--rz-tab-background-text); }

        /* Plugin Section Styling */
        .plugin-section { margin-bottom: 1rem; border: 1px solid var(--rz-sidebar-border); border-radius: 0.5rem; background-color: var(--rz-sidebar-bg); flex-shrink: 0; }
        .plugin-header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; background-color: var(--rz-frame); border-bottom: 1px solid var(--rz-sidebar-border); color: var(--rz-sidebar-text); font-weight: 500; border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; cursor: pointer; }
        .plugin-header .toggle-icon { transition: transform 0.2s ease-in-out; color: var(--rz-sidebar-text); }
        .plugin-header.collapsed { border-bottom-color: transparent; }
        .plugin-header.collapsed .toggle-icon { transform: rotate(-90deg); }
        .plugin-content { padding: 0.75rem; display: block; transition: opacity 0.3s ease, max-height 0.3s ease, padding 0.3s ease, border 0.3s ease; max-height: 1000px; opacity: 1; overflow: hidden; border-top: 1px solid transparent; color: var(--rz-sidebar-text); }
        .plugin-content.hidden { max-height: 0; padding-top: 0; padding-bottom: 0; opacity: 0; border-top: none; overflow: hidden; }

        /* File List Item specific styles */
        .file-list-item { display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 0.5rem; padding: 0.4rem 0.5rem; border-radius: 0.375rem; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; white-space: nowrap; color: var(--rz-sidebar-text); }
        .file-list-item:hover { background-color: var(--rz-sidebar-hover-bg); }
        .file-list-item.active-selection { background-color: var(--rz-sidebar-active-bg); color: var(--rz-sidebar-active-text); }
        .file-list-item input[type="checkbox"] { margin-right: 0.5rem; cursor: pointer; accent-color: var(--rz-sidebar-active-bg); }
        .file-list-item .filename { font-size: 0.85rem; overflow: hidden; text-overflow: ellipsis; cursor: default; }
        .file-list-item .file-actions { display: flex; gap: 0.3rem; align-items: center; }
        .file-actions .btn-xs { padding: 0.15rem 0.3rem; font-size: 0.7rem; line-height: 1; background-color: transparent; color: var(--rz-sidebar-text); border: 1px solid var(--rz-sidebar-text); }
        .file-actions .btn-xs:hover:not(:disabled) { background-color: var(--rz-sidebar-hover-bg); border-color: var(--rz-sidebar-hover-bg); }
        .file-actions .btn-xs:disabled { opacity: 0.4; cursor: not-allowed; background-color: transparent !important; border-color: var(--rz-sidebar-text) !important; color: var(--rz-sidebar-text) !important; }
        .file-actions .btn-xs i { margin-right: 0.2rem; }

        /* Button Styling */
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, border-color 0.2s ease-in-out; cursor: pointer; border: 1px solid transparent; }
        .btn-primary { background-color: var(--rz-button-primary-bg); color: var(--rz-button-primary-text); border-color: var(--rz-button-primary-bg); }
        .btn-primary:hover { background-color: var(--rz-button-primary-hover-bg); border-color: var(--rz-button-primary-hover-bg); }
        .btn-secondary { background-color: var(--rz-button-secondary-bg); color: var(--rz-button-secondary-text); border-color: var(--rz-button-secondary-bg); }
        .btn-secondary:hover { background-color: var(--rz-button-secondary-hover-bg); border-color: var(--rz-button-secondary-hover-bg); }
        .btn-outline { border-color: var(--rz-button-outline-border); color: var(--rz-button-outline-text); background-color: transparent; }
        .btn-outline:hover:not(:disabled) { background-color: var(--rz-button-outline-hover-bg); border-color: var(--rz-button-outline-hover-bg); color: var(--rz-button-outline-hover-text); }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn i.fa-plus, .btn i.fa-paper-plane, .btn i.fa-upload, .btn i.fa-check-double, .btn i.fa-book-open, .btn i.fa-list-alt, .btn i.fa-calendar-days { margin-right: 0.5rem; }
        .btn i.fa-save { margin-right: 0; }

        /* File Input Styling */
        #file-upload-input { display: none; }
        #file-upload-label { cursor: pointer; }

        /* Modal Styling */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(48, 48, 63, 0.7); }
        .modal-content { background-color: var(--rz-popup); margin: 10% auto; padding: 20px; border: 1px solid var(--rz-tab-line); width: 80%; max-width: 600px; border-radius: 0.5rem; position: relative; display: flex; flex-direction: column; max-height: 80vh; color: var(--rz-popup-text); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--rz-tab-line); padding-bottom: 0.5rem; margin-bottom: 1rem; color: var(--rz-popup-text); }
        .modal-title { font-size: 1.1rem; font-weight: 500; }
        .close-btn { color: var(--rz-tab-background-text); font-size: 28px; font-weight: bold; background: none; border: none; cursor: pointer; line-height: 1; }
        .close-btn:hover, .close-btn:focus { color: var(--rz-popup-text); }
        .modal-body { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; }
        #summary-textarea { width: 100%; min-height: 200px; height: 40vh; border: 1px solid var(--rz-tab-line); border-radius: 0.375rem; padding: 0.5rem; font-size: 0.9rem; resize: vertical; background-color: white; color: #374151; }
        #summary-status { min-height: 1.2em; color: var(--rz-popup-text); }
        .modal-footer { display: flex; justify-content: flex-end; gap: 0.5rem; border-top: 1px solid var(--rz-tab-line); padding-top: 1rem; }
        #save-summary-btn.btn-primary { background-color: var(--rz-button-primary-bg); color: var(--rz-button-primary-text); border-color: var(--rz-button-primary-bg); }
        #save-summary-btn.btn-primary:hover { background-color: var(--rz-button-primary-hover-bg); border-color: var(--rz-button-primary-hover-bg); }
        #calendar-modal-content { white-space: pre-wrap; font-family: monospace; font-size: 0.8rem; }

        /* Status Bar Theming */
        #status-bar { background-color: var(--rz-status-bar-bg); color: var(--rz-status-bar-text); border-top: 1px solid var(--rz-frame); }

        /* Toggle Switch Styling */
        .toggle-switch { display: flex; align-items: center; cursor: pointer; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: relative; width: 34px; height: 20px; background-color: var(--rz-frame); border-radius: 17px; transition: background-color 0.2s; margin-right: 8px; }
        .toggle-slider::before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: transform 0.2s; }
        input:checked + .toggle-slider { background-color: var(--rz-toolbar-text); } /* Gold when checked */
        input:checked + .toggle-slider::before { transform: translateX(14px); }

    </style>
</head>
<body class="bg-gray-100">

    <button id="sidebar-toggle-btn" class="toggle-btn" title="Toggle Chat List">
        <i class="fas fa-chevron-left"></i>
    </button>

    <aside id="sidebar">
        <h2 class="text-xl font-semibold mb-4 whitespace-nowrap">Chat Sessions</h2>
        <button id="new-chat-btn" class="btn btn-primary w-full mb-4 flex-shrink-0">
            <i class="fas fa-plus"></i> New Chat
        </button>
        <div class="mb-4 p-3 bg-rz-frame rounded-lg border border-rz-sidebar-border shadow-sm flex-shrink-0">
            <label for="current-chat-name" class="block text-sm font-medium text-rz-sidebar-text mb-1 whitespace-nowrap">Current Chat:</label>
            <div class="flex gap-2 items-center">
                 <input type="text" id="current-chat-name" class="chat-name-input flex-grow text-sm min-w-0" placeholder="Name this chat...">
                 <button id="save-chat-name-btn" class="btn btn-outline p-1.5 flex-shrink-0" title="Save Name">
                     <i class="fas fa-save text-sm"></i>
                 </button>
            </div>
            <div id="current-chat-id-display" class="text-xs text-rz-tab-background-text mt-1 whitespace-nowrap">ID: -</div>
        </div>
        <div class="flex flex-col min-h-0 flex-grow sidebar-section-container">
            <h3 class="text-lg font-medium mb-1 border-t border-rz-sidebar-border pt-3 flex-shrink-0 whitespace-nowrap">Saved Chats</h3>
            <div id="saved-chats-list" class="sidebar-list">
                <p class="text-rz-sidebar-text opacity-75 text-sm p-1">Loading chats...</p>
            </div>
        </div>
    </aside>

    <main id="main-content">
        <div id="main-header">
            <label for="model-selector" class="text-sm font-medium">Model:</label>
            <select id="model-selector" class="model-selector">
                {% for model in available_models %}
                    <option value="{{ model }}" {% if model == default_model %}selected{% endif %}>{{ model }}</option>
                {% endfor %}
            </select>
        </div>

        <div id="chat-area">
            <!-- Area to display the currently attached session file (MOVED BELOW) -->
            <div id="chatbox">
                <div class="system-msg p-4">Initializing chat...</div>
            </div>
        </div>
        <div id="input-area">
             <!-- Container for ALL attached files (session + plugin) -->
             <div id="selected-files-container" class="hidden"></div>
             <div id="input-controls">
                <!-- File upload trigger moved here -->
                <label class="btn btn-secondary btn-sm p-1 flex-shrink-0 self-end mb-1 me-1" id="file-upload-session-label" for="file-upload-session-input" title="Attach file to message" style="height: 42px; line-height: 1.5rem;">
                    <i class="fas fa-paperclip"></i>
                </label>
	       <div id="file-upload-session-container" class="hidden">
    <input type="file" id="file-upload-session-input" accept=".txt,.py,.js,.html,.css,.md,.json,.csv,.pdf,.png,.jpg,.jpeg,.webp,.gif,.mp3,image/*,audio/*,application/pdf">
    <!-- Label moved to input-controls div -->
    <!-- <div id="session-file-display"></div> --> <!-- This div is no longer used -->
</div>
                <textarea id="message-input" rows="2" class="flex-grow p-2 rounded-lg focus:outline-none resize-none text-sm" placeholder="Type your message... (Shift+Enter for newline)"></textarea>
                <button id="send-button" class="btn btn-primary self-end flex-shrink-0" style="height: 42px;">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
        </div>
         <div id="status-bar" class="text-xs px-4 py-1 flex-shrink-0">Status: Idle</div>
    </main>

    <aside id="plugins-sidebar">
        <h2 class="text-xl font-semibold mb-4 whitespace-nowrap">Plugins</h2>
        <div class="plugin-section flex flex-col" id="file-plugin-section">
            <div class="plugin-header flex-shrink-0" id="file-plugin-header">
                <span><i class="fas fa-file-alt mr-2"></i> Files</span>
                <i class="fas fa-chevron-down toggle-icon"></i>
            </div>
            <div class="plugin-content flex flex-col p-2" id="file-plugin-content">
                <input type="file" id="file-upload-input" accept=".txt,.py,.js,.html,.css,.md,.json,.csv,.pdf,.png,.jpg,.jpeg,.webp,.gif,.mp3,image/*,audio/*,application/pdf" multiple>
                <label for="file-upload-input" id="file-upload-label" class="btn btn-secondary btn-sm w-full mb-2 flex-shrink-0">
                    <i class="fas fa-upload"></i> Add New File(s)
                </label>
                <h4 class="text-sm font-medium text-rz-sidebar-text mb-1 flex-shrink-0">Available Files:</h4>
                 <div class="sidebar-section-container flex-grow mb-2 max-h-60">
                   <div id="uploaded-files-list" class="sidebar-list border border-rz-sidebar-border rounded p-1 bg-rz-sidebar-bg">
		     
                        <p class="text-rz-sidebar-text opacity-75 text-xs p-1">Loading files...</p>
                    </div>
                </div>
                <div class="flex gap-2 flex-shrink-0">
                    <button id="attach-full-btn" class="btn btn-outline btn-sm flex-grow">
                        <i class="fas fa-book-open"></i> Attach Full
                    </button>
                     <button id="attach-summary-btn" class="btn btn-outline btn-sm flex-grow">
                        <i class="fas fa-list-alt"></i> Attach Summary
                    </button>
                </div>
            </div>
        </div>

        <div class="plugin-section flex-shrink-0" id="calendar-plugin-section">
             <div class="plugin-header flex-shrink-0" id="calendar-plugin-header">
                 <span><i class="fas fa-calendar-alt mr-2"></i> Google Calendar</span>
                 <i class="fas fa-chevron-down toggle-icon"></i>
            </div>
            <div class="plugin-content p-2 hidden" id="calendar-plugin-content">
                <button id="load-calendar-btn" class="btn btn-secondary btn-sm w-full mb-2">
                    <i class="fas fa-calendar-days"></i> Load Upcoming Events
                </button>
                <button id="view-calendar-btn" class="btn btn-outline btn-sm w-full mb-2 hidden">
                    <i class="fas fa-eye"></i> View Loaded Events
                </button>
                <label class="toggle-switch text-sm mt-1">
                    <input type="checkbox" id="calendar-toggle">
                    <span class="toggle-slider"></span>
                    Include Context
                </label>
                <p id="calendar-status" class="text-xs text-rz-tab-background-text mt-2">Status: Not loaded</p>
            </div>
        </div>
    </aside>

    <button id="plugins-toggle-btn" class="toggle-btn" title="Toggle Plugins">
        <i class="fas fa-chevron-right"></i>
    </button>

    <div id="summary-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">File Summary</h3>
                <button class="close-btn" id="close-summary-modal" title="Close">&times;</button>
            </div>
            <div class="modal-body">
                <p class="text-sm mb-2">Filename: <strong id="summary-modal-filename"></strong></p>
                <textarea id="summary-textarea" placeholder="Loading or generating summary..."></textarea>
                <p id="summary-status" class="text-xs mt-1"></p>
            </div>
            <div class="modal-footer">
                <button id="save-summary-btn" class="btn btn-primary btn-sm">
                    <i class="fas fa-save mr-1"></i> Save Summary
                </button>
            </div>
        </div>
    </div>

    <div id="calendar-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Loaded Calendar Events</h3>
                <button class="close-btn" id="close-calendar-modal" title="Close">&times;</button>
            </div>
            <div class="modal-body">
                <pre id="calendar-modal-content" class="text-xs bg-white p-2 border border-rz-tab-line rounded"></pre>
            </div>
        </div>
    </div>

    <script>
        // DOM Element References (Unchanged)
        const chatbox = document.getElementById('chatbox');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const sidebar = document.getElementById('sidebar');
        const savedChatsList = document.getElementById('saved-chats-list');
        const newChatButton = document.getElementById('new-chat-btn');
        const currentChatNameInput = document.getElementById('current-chat-name');
        const saveChatNameButton = document.getElementById('save-chat-name-btn');
        const currentChatIdDisplay = document.getElementById('current-chat-id-display');
        const statusBar = document.getElementById('status-bar');
        const sidebarToggleButton = document.getElementById('sidebar-toggle-btn');
        const pluginsSidebar = document.getElementById('plugins-sidebar');
        const pluginsToggleButton = document.getElementById('plugins-toggle-btn');
        const fileUploadInput = document.getElementById('file-upload-input');
        const uploadedFilesList = document.getElementById('uploaded-files-list');
        const selectedFilesContainer = document.getElementById('selected-files-container');
        const bodyElement = document.body;
        const filePluginHeader = document.getElementById('file-plugin-header');
        const filePluginContent = document.getElementById('file-plugin-content');
        const attachFullButton = document.getElementById('attach-full-btn');
        const attachSummaryButton = document.getElementById('attach-summary-btn');
        const summaryModal = document.getElementById('summary-modal');
        const closeSummaryModalButton = document.getElementById('close-summary-modal');
        const summaryModalFilename = document.getElementById('summary-modal-filename');
        const summaryTextarea = document.getElementById('summary-textarea');
        const saveSummaryButton = document.getElementById('save-summary-btn');
        const summaryStatus = document.getElementById('summary-status');
        const modelSelector = document.getElementById('model-selector');
        const calendarPluginHeader = document.getElementById('calendar-plugin-header');
        const calendarPluginContent = document.getElementById('calendar-plugin-content');
        const loadCalendarButton = document.getElementById('load-calendar-btn');
        const calendarToggle = document.getElementById('calendar-toggle');
        const calendarStatus = document.getElementById('calendar-status');
        const viewCalendarButton = document.getElementById('view-calendar-btn');
        const calendarModal = document.getElementById('calendar-modal');
        const closeCalendarModalButton = document.getElementById('close-calendar-modal');
        const calendarModalContent = document.getElementById('calendar-modal-content');

        // Application State (Added Calendar state)
        let currentChatId = null;
        let isLoading = false;
        let selectedFiles = [];
        let currentEditingFileId = null;
        let calendarContext = null; // Store loaded calendar events text
        let isCalendarContextActive = false; // Track toggle state
        const defaultModel = modelSelector.value;
        const SIDEBAR_COLLAPSED_KEY = 'sidebarCollapsed';
        const PLUGINS_COLLAPSED_KEY = 'pluginsCollapsed';
        const FILE_PLUGIN_COLLAPSED_KEY = 'filePluginCollapsed';
        const CALENDAR_PLUGIN_COLLAPSED_KEY = 'calendarPluginCollapsed';
        const MAX_FILE_SIZE_MB = 10;
        const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;

        // --- Utility Functions (Unchanged) ---
      function updateStatus(message, isError = false) { statusBar.textContent = `Status: ${message}`; statusBar.className = `text-xs px-4 py-1 flex-shrink-0 ${isError ? 'text-red-600 bg-red-50 border-t border-red-200' : 'text-rz-status-bar-text bg-rz-status-bar-bg border-t border-rz-frame'}`; console.log(`Status Update: ${message}`); }
      async function deleteFile(fileId) {
            if (isLoading) return;
            if (!confirm("Are you sure you want to delete this file? This action cannot be undone.")) {
                return;
            }

            setLoadingState(true, "Deleting File");
            updateStatus(`Deleting file ${fileId}...`);

            try {
                const response = await fetch(`/api/files/${fileId}`, { method: 'DELETE' });
                if (!response.ok) {
                    const errorData = await response.json();
		    throw new Error(`${errorData.error || `HTTP error! status: ${response.status}`}`);
                }

                updateStatus(`File ${fileId} deleted.`);
                await loadUploadedFiles(); // Reload the file list

                // Remove from selected files if it's selected
                selectedFiles = selectedFiles.filter(f => f.id !== fileId);
                renderSelectedFiles();

            } catch (error) {
                console.error('Error deleting file:', error);
                updateStatus(`Error deleting file: ${error.message}`, true);
            } finally {
                setLoadingState(false);
            }
        } 
      
        function setLoadingState(loading, operation = "Processing") { isLoading = loading; messageInput.disabled = loading; sendButton.disabled = loading; newChatButton.disabled = loading; saveChatNameButton.disabled = loading; sidebarToggleButton.disabled = loading; pluginsToggleButton.disabled = loading; fileUploadInput.disabled = loading; attachFullButton.disabled = loading; attachSummaryButton.disabled = loading; saveSummaryButton.disabled = loading; modelSelector.disabled = loading; loadCalendarButton.disabled = loading; calendarToggle.disabled = loading; viewCalendarButton.disabled = loading || !calendarContext; uploadedFilesList.querySelectorAll('input[type="checkbox"], button').forEach(el => el.disabled = loading); selectedFilesContainer.querySelectorAll('button').forEach(el => el.disabled = loading); sendButton.innerHTML = loading ? `<i class="fas fa-spinner fa-spin mr-2"></i> ${operation}...` : '<i class="fas fa-paper-plane mr-2"></i> Send'; if (loading) { updateStatus(`${operation}...`); } else { updateStatus("Idle"); if (!bodyElement.classList.contains('sidebar-collapsed')) { messageInput.focus(); } } }

        // --- Sidebar & Plugin Toggle Functions (Unchanged) ---
        function setSidebarCollapsed(sidebarElement, toggleButton, collapsed, storageKey, positionClass) { const icon = toggleButton.querySelector('i'); const bodyClass = `${positionClass}-collapsed`; const isLeft = positionClass === 'sidebar'; const expandIcon = isLeft ? 'fa-chevron-left' : 'fa-chevron-right'; const collapseIcon = isLeft ? 'fa-chevron-right' : 'fa-chevron-left'; if (collapsed) { bodyElement.classList.add(bodyClass); icon.classList.remove(expandIcon); icon.classList.add(collapseIcon); toggleButton.title = `Expand ${isLeft ? 'Chat List' : 'Plugins'}`; localStorage.setItem(storageKey, 'true'); } else { bodyElement.classList.remove(bodyClass); icon.classList.remove(collapseIcon); icon.classList.add(expandIcon); toggleButton.title = `Collapse ${isLeft ? 'Chat List' : 'Plugins'}`; localStorage.setItem(storageKey, 'false'); } if (!collapsed && !isLoading) { setTimeout(() => messageInput.focus(), 350); } }
        function toggleLeftSidebar() { setSidebarCollapsed(sidebar, sidebarToggleButton, !bodyElement.classList.contains('sidebar-collapsed'), SIDEBAR_COLLAPSED_KEY, 'sidebar'); }
        function toggleRightSidebar() { setSidebarCollapsed(pluginsSidebar, pluginsToggleButton, !bodyElement.classList.contains('plugins-collapsed'), PLUGINS_COLLAPSED_KEY, 'plugins'); }
        function setPluginSectionCollapsed(headerElement, contentElement, collapsed, storageKey) { const icon = headerElement.querySelector('.toggle-icon'); if (collapsed) { headerElement.classList.add('collapsed'); contentElement.classList.add('hidden'); if (icon) { icon.classList.remove('fa-chevron-down'); icon.classList.add('fa-chevron-up'); } localStorage.setItem(storageKey, 'true'); } else { headerElement.classList.remove('collapsed'); contentElement.classList.remove('hidden'); if (icon) { icon.classList.remove('fa-chevron-up'); icon.classList.add('fa-chevron-down'); } localStorage.setItem(storageKey, 'false'); } }
        function toggleFilePlugin() { const isCollapsed = filePluginContent.classList.contains('hidden'); setPluginSectionCollapsed(filePluginHeader, filePluginContent, !isCollapsed, FILE_PLUGIN_COLLAPSED_KEY); }
      function toggleCalendarPlugin() { const isCollapsed = calendarPluginContent.classList.contains('hidden'); setPluginSectionCollapsed(calendarPluginHeader, calendarPluginContent, !isCollapsed, CALENDAR_PLUGIN_COLLAPSED_KEY); }


      /// uploads in the main chat location
      
const fileUploadSessionInput = document.getElementById('file-upload-session-input');
const fileUploadSessionLabel = document.getElementById('file-upload-session-label');
// const sessionFileDisplayArea = document.getElementById('session-file-display-area'); // Removed
let sessionFile = null; // Variable to store selected session file

// Show the file upload container
fileUploadSessionLabel.addEventListener('click', () => {
    fileUploadSessionContainer.classList.remove('hidden');
    fileUploadSessionInput.click(); // Simulate click to open file dialog.
});

// Event Listener for Session File Input
fileUploadSessionInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    // Clear any existing session file tag first
    const existingSessionTag = selectedFilesContainer.querySelector('.session-file-tag');
    if (existingSessionTag) {
        existingSessionTag.remove();
    }

    if (!file) {
        sessionFile = null; // Ensure sessionFile is null if no file is chosen
        renderSelectedFiles(); // Re-render to ensure container visibility is correct
        return;
    }

    // Reset sessionFile before reading the new one
    sessionFile = null;
    // Show loading state within the shared container
    selectedFilesContainer.classList.remove('hidden');
    const loadingTag = document.createElement('span');
    loadingTag.classList.add('selected-file-tag', 'session-file-tag', 'opacity-75'); // Add session-file-tag class
    loadingTag.innerHTML = `<span class="text-xs">Loading ${file.name}...</span>`;
    selectedFilesContainer.appendChild(loadingTag);


    const reader = new FileReader();
    reader.onload = function(event) {
        // Remove loading tag
        loadingTag.remove();
        // Store file details AND content
        sessionFile = {
            filename: file.name,
            mimetype: file.type,
            content: event.target.result // Store the Base64 content
        };

        // Update display in the shared container
        selectedFilesContainer.classList.remove('hidden'); // Ensure container is visible
        const tag = document.createElement('span');
        tag.classList.add('selected-file-tag', 'session-file-tag'); // Add session-file-tag class
        tag.innerHTML = `
            <i class="fas fa-paperclip mr-1 text-xs"></i> <!-- Icon for session file -->
            <span class="filename truncate" title="${file.name}">${file.name}</span>
            <span class="file-type">SESSION</span> <!-- Differentiate session file -->
            <button title="Remove Attachment" class="ml-2">&times;</button>
        `;
        tag.querySelector('button').onclick = () => {
            sessionFile = null; // Clear the selected file state.
            tag.remove(); // Remove the tag itself.
            renderSelectedFiles(); // Re-render to potentially hide container if empty
            fileUploadSessionInput.value = ''; // Reset file input
        };
        // Prepend session file tag for visual distinction or append, user preference? Let's prepend.
        selectedFilesContainer.prepend(tag);
    }
    reader.onerror = function(error) {
        // Remove loading tag if it exists
        loadingTag.remove();
        console.error("Error reading file:", error);
        // Optionally show error in the container or just log it
        // Example: add a temporary error tag
        const errorTag = document.createElement('span');
        errorTag.classList.add('selected-file-tag', 'session-file-tag', 'bg-red-100', 'text-red-700', 'border-red-300');
        errorTag.textContent = `Error loading ${file.name}`;
        selectedFilesContainer.prepend(errorTag);
        setTimeout(() => errorTag.remove(), 3000); // Remove error after 3s

        sessionFile = null;
        fileUploadSessionInput.value = ''; // Reset file input
        renderSelectedFiles(); // Re-render to potentially hide container
    }
    reader.readAsDataURL(file); // Read file as data URL (Base64)
});




      
// Assume 'marked' is available globally or imported
// Make sure you have 
// and Font Awesome if using the UI markers.

// Create a custom renderer to apply your specific classes
// to code blocks and inline code, matching the original function's output.
const renderer = new marked.Renderer();

// Helper function for basic HTML escaping within code
function escapeHtml(html) {
  return html
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

 renderer.code = function(code, language) {
  // Ensure the input 'code' is treated as a string and escape its content
    const escapedCode = escapeHtml(String(code.text));
    console.log(escapedCode)
    return `<pre class="bg-gray-800 text-white p-2 rounded mt-1 overflow-x-auto text-sm font-mono"><code>${escapedCode}</code></pre>`;
};

renderer.codespan = function(text) {
   // Ensure the input 'text' is treated as a string and escape its content
   const escapedText = escapeHtml(String(text.text));

   // Return the HTML string with your desired classes
   return `<code class="bg-gray-200 px-1 rounded text-sm font-mono">${escapedText}</code>`;
};

// Define options for marked.parse
// Use the custom renderer
// Note: marked's default behavior for newlines is different from your original
const markedOptions = {
renderer: renderer,
   breaks: true 
};


function addMessage(role, content, isError = false) {
    const messageDiv = document.createElement('div');
    if (role === 'system') {
        messageDiv.classList.add('system-msg');
    } else {
        messageDiv.classList.add('message');
        if (isError) messageDiv.classList.add('error-msg');
        else messageDiv.classList.add(role === 'user' ? 'user-msg' : 'assistant-msg');
    }
    console.log("content")
    console.log(content)
    let processedContent = content;
    processedContent = processedContent.replace(/\[UI-MARKER:file:(.*?):(.*?)\]/g, (match, filename, type) => `<span class="attachment-icon" title="Attached ${filename} (${type})"><i class="fas fa-paperclip"></i> ${filename}</span>`).replace(/\[UI-MARKER:calendar\]/g, `<span class="attachment-icon" title="Calendar Context Active"><i class="fas fa-calendar-check"></i> Calendar</span>`).replace(/\[UI-MARKER:error:(.*?)\]/g, (match, filename) => `<span class="attachment-icon error-marker" title="Error attaching ${filename}"><i class="fas fa-exclamation-circle"></i> ${filename}</span>`);
    console.log("processed Content")
    console.log(processedContent)
    const htmlContent = marked.parse(processedContent, markedOptions);

    messageDiv.innerHTML = htmlContent;

    // Assuming 'chatbox' is a pre-existing element in your DOM
    const chatbox = document.getElementById('chatbox');

    if (chatbox) {
        chatbox.appendChild(messageDiv); 
        chatbox.scrollTop = chatbox.scrollHeight;
    } else {
        console.error("Chatbox element with ID 'chatbox' not found.");
    }
}

// Example usage (assuming chatbox element exists in your HTML):
// addMessage('user', 'Hello **world**!');
// addMessage('assistant', 'Here is some `inline code` and a ```javascript\nconsole.log("block");\n```');
// addMessage('assistant', 'Attached file: [UI-MARKER:file:report.pdf:application/pdf]');
// addMessage('system', 'System message here.');
// addMessage('assistant', 'Error during attach: [UI-MARKER:error:image.jpg]', true);


      

async function loadUploadedFiles() {
    updateStatus("Loading uploaded files...");
    uploadedFilesList.innerHTML = `<p class="text-rz-sidebar-text opacity-75 text-xs p-1">Loading...</p>`;
    try {
        const response = await fetch('/api/files');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const files = await response.json();
        uploadedFilesList.innerHTML = '';
        if (files.length === 0) {
            uploadedFilesList.innerHTML = `<p class="text-rz-sidebar-text opacity-75 text-xs p-1">No files uploaded yet.</p>`;
        } else {
            files.forEach(file => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('file-list-item');
                itemDiv.dataset.fileId = file.id;
                itemDiv.dataset.filename = file.filename;
                itemDiv.dataset.hasSummary = file.has_summary;
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = file.id;
                checkbox.classList.add('file-checkbox');
                checkbox.title = "Select file";
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) itemDiv.classList.add('active-selection');
                    else itemDiv.classList.remove('active-selection');
                });
                const nameSpan = document.createElement('span');
                nameSpan.textContent = file.filename;
                nameSpan.classList.add('filename');
                nameSpan.title = file.filename;
                const actionsDiv = document.createElement('div');
                actionsDiv.classList.add('file-actions');
                const summaryBtn = document.createElement('button');
                summaryBtn.classList.add('btn', 'btn-outline', 'btn-xs');
                summaryBtn.innerHTML = '<i class="fas fa-file-alt"></i>';
                summaryBtn.title = "View/Edit Summary";
                summaryBtn.disabled = false;
                summaryBtn.onclick = (e) => {
                    e.stopPropagation();
                    showSummaryModal(file.id, file.filename);
                };
                actionsDiv.appendChild(summaryBtn);

                // --- Add Delete Button Here ---
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('btn', 'btn-outline', 'btn-xs', 'delete-btn'); // Added 'delete-btn' class
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                deleteBtn.title = "Delete File";
                deleteBtn.onclick = (e) => {
                    e.stopPropagation(); // Stop itemDiv onclick from triggering
                    deleteFile(file.id); // Call the deleteFile function
                };
                actionsDiv.appendChild(deleteBtn);
                // --- End Delete Button ---

                itemDiv.appendChild(checkbox);
                itemDiv.appendChild(nameSpan);
                itemDiv.appendChild(actionsDiv);
                uploadedFilesList.appendChild(itemDiv);
            });
        }
        updateStatus("Uploaded files loaded.");
    } catch (error) {
        console.error('Error loading uploaded files:', error);
        uploadedFilesList.innerHTML = '<p class="text-red-500 text-xs p-1">Error loading files.</p>';
        updateStatus("Error loading files.", true);
    }
}

      
      function handleFileUpload(event) { const files = event.target.files; if (!files || files.length === 0) return; setLoadingState(true, "Uploading"); const formData = new FormData(); let fileCount = 0; for (const file of files) { if (file.size > MAX_FILE_SIZE_BYTES) { alert(`Skipping "${file.name}": File is too large (${formatFileSize(file.size)}). Max size is ${MAX_FILE_SIZE_MB} MB.`); continue; } formData.append('file', file); fileCount++; } if (fileCount === 0) { setLoadingState(false); fileUploadInput.value = ''; updateStatus("No valid files selected for upload.", true); return; } fetch('/api/files', { method: 'POST', body: formData }) .then(async response => { const data = await response.json(); if (!response.ok) { throw new Error(data.error || `HTTP error! status: ${response.status}`); } const successfulUploads = data.uploaded_files?.length || 0; const errors = data.errors || []; let statusMsg = `Uploaded ${successfulUploads} file(s).`; if (errors.length > 0) { statusMsg += ` ${errors.length} failed: ${errors.join('; ')}`; console.warn("Upload errors:", errors); } updateStatus(statusMsg, errors.length > 0); }) .catch(error => { console.error('Error uploading files:', error); updateStatus(`Error uploading files: ${error.message}`, true); }) .finally(async () => { await loadUploadedFiles(); setLoadingState(false); fileUploadInput.value = ''; }); }
      
        function attachSelectedFiles(type) { const checkboxes = uploadedFilesList.querySelectorAll('.file-checkbox:checked'); if (checkboxes.length === 0) { updateStatus("No files selected to attach.", true); return; } let addedCount = 0; checkboxes.forEach(checkbox => { const fileId = parseInt(checkbox.value); const listItem = checkbox.closest('.file-list-item'); const filename = listItem.dataset.filename; const alreadySelected = selectedFiles.some(f => f.id === fileId && f.type === type); if (!alreadySelected) { selectedFiles = selectedFiles.filter(f => !(f.id === fileId)); selectedFiles.push({ id: fileId, filename: filename, type: type }); addedCount++; } checkbox.checked = false; listItem.classList.remove('active-selection'); }); renderSelectedFiles(); if (addedCount > 0) { updateStatus(`${addedCount} file(s) added as ${type}.`); } else { updateStatus(`Selected file(s) already attached as ${type}.`); } }
        function removeSelectedFile(fileId, type) { selectedFiles = selectedFiles.filter(f => !(f.id === fileId && f.type === type)); renderSelectedFiles(); updateStatus(`File attachment removed.`); }
        function renderSelectedFiles() {
            // Clear only non-session file tags
            selectedFilesContainer.querySelectorAll('.selected-file-tag:not(.session-file-tag)').forEach(tag => tag.remove());

            // Render plugin-selected files
            selectedFiles.forEach(file => {
                const tag = document.createElement('span');
                tag.classList.add('selected-file-tag'); // No session-file-tag class here
                tag.innerHTML = `
                    <span class="filename truncate" title="${file.filename}">${file.filename}</span>
                    <span class="file-type">${file.type.toUpperCase()}</span>
                    <button title="Remove Attachment">&times;</button>
                `;
                tag.querySelector('button').onclick = () => removeSelectedFile(file.id, file.type);
                selectedFilesContainer.appendChild(tag); // Append plugin files
            });

            // Update container visibility based on whether *any* tags exist (session or plugin)
            if (selectedFilesContainer.children.length === 0) {
                selectedFilesContainer.classList.add('hidden');
            } else {
                selectedFilesContainer.classList.remove('hidden');
            }
        }

        // --- Summary Modal Functions (Unchanged) ---
        async function showSummaryModal(fileId, filename) { currentEditingFileId = fileId; summaryModalFilename.textContent = filename; summaryTextarea.value = ""; summaryTextarea.placeholder = "Loading or generating summary..."; summaryStatus.textContent = ""; summaryStatus.classList.remove('text-red-500'); summaryModal.style.display = "block"; saveSummaryButton.disabled = true; updateStatus(`Fetching summary for ${filename}...`); try { const response = await fetch(`/api/files/${fileId}/summary`); if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error || `HTTP ${response.status}`); } const data = await response.json(); summaryTextarea.value = data.summary; summaryTextarea.placeholder = "Enter or edit summary here."; saveSummaryButton.disabled = false; updateStatus(`Summary loaded for ${filename}.`); if (data.summary.startsWith("[Error") || data.summary.startsWith("[Summary not applicable")) { summaryStatus.textContent = data.summary; summaryStatus.classList.add('text-red-500'); saveSummaryButton.disabled = data.summary.startsWith("[Summary not applicable"); } else { summaryStatus.textContent = "Summary loaded. You can edit and save changes."; } } catch (error) { console.error("Error fetching summary:", error); summaryTextarea.value = `[Error loading summary: ${error.message}]`; summaryTextarea.placeholder = "Could not load summary."; updateStatus(`Error fetching summary for ${filename}.`, true); summaryStatus.textContent = `Error: ${error.message}`; summaryStatus.classList.add('text-red-500'); } }
        async function saveSummary() { if (!currentEditingFileId || isLoading) return; const updatedSummary = summaryTextarea.value; setLoadingState(true, "Saving Summary"); summaryStatus.textContent = "Saving..."; summaryStatus.classList.remove('text-red-500'); try { const response = await fetch(`/api/files/${currentEditingFileId}/summary`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ summary: updatedSummary }) }); if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error || `HTTP ${response.status}`); } updateStatus("Summary saved successfully."); summaryStatus.textContent = "Summary saved!"; await loadUploadedFiles(); closeModal(); } catch (error) { console.error("Error saving summary:", error); updateStatus("Error saving summary.", true); summaryStatus.textContent = `Error saving: ${error.message}`; summaryStatus.classList.add('text-red-500'); } finally { setLoadingState(false); } }
        function closeModal() { summaryModal.style.display = "none"; currentEditingFileId = null; }
        function closeCalendarModal() { calendarModal.style.display = "none"; }

        // --- Calendar Plugin Functions (MODIFIED) ---
        /** Fetches calendar events and updates state/UI. */
        async function loadCalendarEvents() {
            if (isLoading) return;
            setLoadingState(true, "Loading Events");
            updateStatus("Loading calendar events...");
            // addMessage('system', 'Fetching Google Calendar events...'); // No longer add system message

            try {
                const response = await fetch('/api/calendar/events');
                const data = await response.json();

                if (!response.ok) { throw new Error(data.error || `HTTP error ${response.status}`); }

                calendarContext = data.events || "[No event data received]"; // Store formatted events
                updateCalendarStatus(); // Update status display based on loaded context and toggle state
                viewCalendarButton.classList.remove('hidden'); // Show view button
                viewCalendarButton.disabled = false;
                updateStatus("Calendar events loaded.");

            } catch (error) {
                console.error('Error loading calendar events:', error);
                calendarContext = null; // Clear context on error
                updateCalendarStatus(); // Update status display
                viewCalendarButton.classList.add('hidden'); // Hide view button
                viewCalendarButton.disabled = true;
                addMessage('system', `[Error loading calendar events: ${error.message}]`, true); // Show error in chat
                updateStatus(`Error loading calendar events: ${error.message}`, true);
            } finally {
                 setLoadingState(false);
            }
        }

        /** Updates the calendar status text based on loaded context and toggle state. */
        function updateCalendarStatus() {
            if (calendarContext) {
                calendarStatus.textContent = `Status: Events loaded. Context: ${isCalendarContextActive ? 'Active' : 'Inactive'}`;
                calendarStatus.classList.remove('text-red-500');
            } else {
                calendarStatus.textContent = "Status: Not loaded";
                calendarStatus.classList.remove('text-red-500');
            }
        }

        /** Handles changes to the calendar context toggle switch. */
        function handleCalendarToggle() {
            isCalendarContextActive = calendarToggle.checked;
            localStorage.setItem('calendarContextActive', isCalendarContextActive); // Persist toggle state
            updateCalendarStatus(); // Update display text
        }

        /** Shows the modal with the loaded calendar events. */
        function showCalendarModal() {
            if (calendarContext) {
                calendarModalContent.textContent = calendarContext; // Display raw text in <pre>
                calendarModal.style.display = 'block';
            } else {
                updateStatus("No calendar events loaded to view.", true);
            }
        }

 function clearChatbox() { chatbox.innerHTML = ''; }
	
        // --- API Interaction (Chats - MODIFIED sendMessage) ---
        async function loadSavedChats() { updateStatus("Loading saved chats..."); try { const response = await fetch('/api/chats'); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); const chats = await response.json(); savedChatsList.innerHTML = ''; if (chats.length === 0) { savedChatsList.innerHTML = `<p class="text-rz-sidebar-text opacity-75 text-sm p-1">No saved chats yet.</p>`; } else { chats.forEach(chat => { const listItem = document.createElement('div'); listItem.classList.add('list-item', 'chat-list-item'); listItem.dataset.chatId = chat.id; const nameSpan = document.createElement('span'); nameSpan.textContent = chat.name || `Chat ${chat.id}`; nameSpan.classList.add('filename'); nameSpan.title = chat.name || `Chat ${chat.id}`; const deleteButton = document.createElement('button'); deleteButton.classList.add('delete-btn'); deleteButton.innerHTML = '<i class="fas fa-trash-alt fa-xs"></i>'; deleteButton.title = "Delete Chat"; deleteButton.onclick = (e) => { e.stopPropagation(); handleDeleteChat(chat.id, listItem); }; listItem.appendChild(nameSpan); listItem.appendChild(deleteButton); listItem.onclick = () => { if (chat.id != currentChatId) { loadChat(chat.id); } }; savedChatsList.appendChild(listItem); }); } updateActiveChatListItem(); updateStatus("Saved chats loaded."); } catch (error) { console.error('Error loading saved chats:', error); savedChatsList.innerHTML = '<p class="text-red-500 text-sm p-1">Error loading chats.</p>'; updateStatus("Error loading saved chats.", true); } }
      async function startNewChat() { if (isLoading) return; setLoadingState(true, "Creating Chat"); updateStatus("Creating new chat..."); try { const response = await fetch('/api/chat', { method: 'POST' }); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); const newChat = await response.json(); await loadChat(newChat.id);await loadSavedChats();
            updateStatus(`New chat created (ID: ${newChat.id}).`);
            setSidebarCollapsed(sidebar, sidebarToggleButton, false, SIDEBAR_COLLAPSED_KEY, 'sidebar');
            selectedFiles = []; // Clear permanent file selections
            sessionFile = null; // Clear session file state
            // Clear session file tag from container
            const existingSessionTag = selectedFilesContainer.querySelector('.session-file-tag');
            if (existingSessionTag) existingSessionTag.remove();
            renderSelectedFiles(); // Render (clears plugin files and updates visibility)
            fileUploadSessionInput.value = ''; // Reset session file input
            calendarContext = null;
            isCalendarContextActive = false;
            calendarToggle.checked = false; updateCalendarStatus(); viewCalendarButton.classList.add('hidden'); modelSelector.value = defaultModel; } catch (error) { console.error('Error starting new chat:', error); addMessage('system', `[Error creating new chat: ${error.message}]`, true); updateStatus("Error creating new chat.", true); } finally { setLoadingState(false); } }
      async function loadChat(chatId) { if (isLoading) return; setLoadingState(true, "Loading Chat"); updateStatus(`Loading chat ${chatId}...`); clearChatbox(); addMessage('system', `Loading chat (ID: ${chatId})...`); try { const response = await fetch(`/api/chat/${chatId}`); if (!response.ok) throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`); const data = await response.json(); currentChatId = chatId; clearChatbox(); currentChatNameInput.value = data.details.name || ''; currentChatIdDisplay.textContent = `ID: ${currentChatId}`; modelSelector.value = data.details.model_name || defaultModel; if (data.history.length === 0) { addMessage('system', 'This chat is empty. Start typing!'); } else { data.history.forEach(msg => addMessage(msg.role, msg.content)); }


					updateActiveChatListItem();
            updateStatus(`Chat ${chatId} loaded.`);
            setSidebarCollapsed(sidebar, sidebarToggleButton, false, SIDEBAR_COLLAPSED_KEY, 'sidebar');
            selectedFiles = []; // Clear permanent file selections
            sessionFile = null; // Clear session file state
            // Clear session file tag from container
            const existingSessionTag = selectedFilesContainer.querySelector('.session-file-tag');
            if (existingSessionTag) existingSessionTag.remove();
            renderSelectedFiles(); // Render (clears plugin files and updates visibility)
            fileUploadSessionInput.value = ''; // Reset session file input
            calendarContext = null;
            isCalendarContextActive = false;
            calendarToggle.checked = false;																							updateCalendarStatus(); viewCalendarButton.classList.add('hidden'); } catch (error) { console.error('Error loading chat:', error); clearChatbox(); addMessage('system', `[Error loading chat ${chatId}: ${error.message}]`, true); currentChatId = null; currentChatNameInput.value = ''; currentChatIdDisplay.textContent = 'ID: -'; modelSelector.value = defaultModel; updateStatus(`Error loading chat ${chatId}.`, true); updateActiveChatListItem(); } finally { setLoadingState(false); } }

        /** Sends message, attached files, and optionally calendar context to backend. */
        async function sendMessage() {
            if (isLoading || !currentChatId) { updateStatus("Cannot send message: No active chat or busy.", true); return; }
            const message = messageInput.value.trim();
            if (!message && selectedFiles.length === 0 && (!isCalendarContextActive || !calendarContext)) { updateStatus("Cannot send: Type a message or attach file(s)/active context.", true); return; }

            // --- Display user message + UI markers immediately ---
            let displayMessage = message || ((selectedFiles.length > 0 || (isCalendarContextActive && calendarContext)) ? "(Context attached)" : "");
            let uiMarkers = "";
            if (selectedFiles.length > 0) {
                // Use non-HTML placeholder for files
                uiMarkers = selectedFiles.map(f => `[UI-MARKER:file:${f.filename}:${f.type}]`).join('');
            }
            if (isCalendarContextActive && calendarContext) {
                // Use non-HTML placeholder for calendar
                uiMarkers += `[UI-MARKER:calendar]`;
            }
            // Prepend placeholders to the actual message text
            displayMessage = uiMarkers + (uiMarkers ? "\n" : "") + displayMessage; // Add newline if markers exist
            addMessage('user', displayMessage); // addMessage will handle replacing placeholders

            messageInput.value = '';
            setLoadingState(true, "Sending");
            updateStatus("Sending message...");

            // --- Prepare payload for backend ---
	    const payload = {
		message: message,
		attached_files: selectedFiles,
		calendar_context: (isCalendarContextActive && calendarContext) ? calendarContext : null,
		// Use the stored sessionFile object which now includes content
		session_files: sessionFile ? [{ filename: sessionFile.filename, content: sessionFile.content, mimetype: sessionFile.mimetype }] : []
	    };

            // Store session file temporarily to clear it in finally block
            const sentSessionFile = sessionFile;

            try {
                const response = await fetch(`/api/chat/${currentChatId}/message`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error || `HTTP error! status: ${response.status}`); }
                const data = await response.json();
                addMessage('assistant', data.reply);
                updateStatus("Assistant replied.");
                await loadSavedChats();
                // Clear selected files, but keep calendar context loaded and active/inactive state
                selectedFiles = [];
                renderSelectedFiles();
            } catch (error) {
                console.error('Error sending message:', error);
                addMessage('assistant', `[Error: ${error.message}]`, true);
                updateStatus("Error sending message.", true);
            } finally {
                // Clear the session file state and its tag if it was the one sent
                if (sentSessionFile && sessionFile === sentSessionFile) {
                    sessionFile = null;
                    const existingSessionTag = selectedFilesContainer.querySelector('.session-file-tag');
                    if (existingSessionTag) existingSessionTag.remove();
                    renderSelectedFiles(); // Update container visibility if needed
                    fileUploadSessionInput.value = ''; // Reset file input
                }
                setLoadingState(false);
            }
        }
        async function handleSaveChatName() { if (isLoading || !currentChatId) { updateStatus("Cannot save name: No active chat or busy.", true); return; } const newName = currentChatNameInput.value.trim(); setLoadingState(true, "Saving Name"); updateStatus(`Saving name for chat ${currentChatId}...`); try { const response = await fetch(`/api/chat/${currentChatId}/name`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: newName || 'New Chat' }), }); if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error || `HTTP error! status: ${response.status}`); } updateStatus(`Chat ${currentChatId} name saved as "${newName || 'New Chat'}".`); await loadSavedChats(); } catch (error) { console.error('Error saving chat name:', error); updateStatus(`Error saving name: ${error.message}`, true); } finally { setLoadingState(false); } }
        async function handleDeleteChat(chatId, listItemElement) { if (isLoading) return; const chatName = listItemElement.querySelector('span.filename').textContent || `Chat ${chatId}`; if (!confirm(`Are you sure you want to delete "${chatName}"? This cannot be undone.`)) { return; } setLoadingState(true, "Deleting Chat"); updateStatus(`Deleting chat ${chatId}...`); try { const response = await fetch(`/api/chat/${chatId}`, { method: 'DELETE' }); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); updateStatus(`Chat ${chatId} deleted.`); listItemElement.remove(); if (!savedChatsList.querySelector('.list-item')) { savedChatsList.innerHTML = `<p class="text-rz-sidebar-text opacity-75 text-sm p-1">No saved chats yet.</p>`; } if (chatId == currentChatId) { await startNewChat(); } } catch (error) { console.error(`Error deleting chat ${chatId}:`, error); updateStatus(`Error deleting chat: ${error.message}`, true); addMessage('system', `[Error deleting chat ${chatId}: ${error.message}]`, true); } finally { setLoadingState(false); } }
        function updateActiveChatListItem() { const items = savedChatsList.querySelectorAll('.chat-list-item'); items.forEach(item => { if (item.dataset.chatId == currentChatId) { item.classList.add('active'); } else { item.classList.remove('active'); } }); }
        async function handleModelChange() { if (!currentChatId || isLoading) return; const newModel = modelSelector.value; updateStatus(`Updating model to ${newModel}...`); setLoadingState(true, "Updating Model"); try { const response = await fetch(`/api/chat/${currentChatId}/model`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ model_name: newModel }) }); if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error || `HTTP ${response.status}`); } updateStatus(`Model updated to ${newModel} for this chat.`); } catch (error) { console.error("Error updating model:", error); updateStatus(`Error updating model: ${error.message}`, true); } finally { setLoadingState(false); } }


        // --- Event Listeners Setup ---
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
        newChatButton.addEventListener('click', startNewChat);
        saveChatNameButton.addEventListener('click', handleSaveChatName);
        currentChatNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleSaveChatName(); currentChatNameInput.blur(); } });
        sidebarToggleButton.addEventListener('click', toggleLeftSidebar);
        pluginsToggleButton.addEventListener('click', toggleRightSidebar);
        // File Plugin Listeners
        filePluginHeader.addEventListener('click', toggleFilePlugin);
        fileUploadInput.addEventListener('change', handleFileUpload);
        attachFullButton.addEventListener('click', () => attachSelectedFiles('full'));
        attachSummaryButton.addEventListener('click', () => attachSelectedFiles('summary'));
        // Calendar Plugin Listeners
        calendarPluginHeader.addEventListener('click', toggleCalendarPlugin);
        loadCalendarButton.addEventListener('click', loadCalendarEvents);
        calendarToggle.addEventListener('change', handleCalendarToggle); // Listen to toggle change
        viewCalendarButton.addEventListener('click', showCalendarModal); // Listen to view button
        closeCalendarModalButton.addEventListener('click', closeCalendarModal); // Calendar modal close
        // Summary Modal Listeners
        closeSummaryModalButton.addEventListener('click', closeModal);
        saveSummaryButton.addEventListener('click', saveSummary);
        summaryModal.addEventListener('click', (event) => { if (event.target === summaryModal) { closeModal(); } });
        // Calendar Modal Background Close
        calendarModal.addEventListener('click', (event) => { if (event.target === calendarModal) { closeCalendarModal(); } });
        // Model Selector Listener
        modelSelector.addEventListener('change', handleModelChange);


        // --- Initial Application Load ---
        /** Initializes the application on page load. */
        async function initializeApp() {
            const chatSidebarCollapsed = localStorage.getItem(SIDEBAR_COLLAPSED_KEY) === 'true';
            const pluginSidebarCollapsed = localStorage.getItem(PLUGINS_COLLAPSED_KEY) === 'true';
            const filePluginCollapsed = localStorage.getItem(FILE_PLUGIN_COLLAPSED_KEY) === 'true';
            const calendarPluginCollapsed = localStorage.getItem(CALENDAR_PLUGIN_COLLAPSED_KEY) === 'true';
            setSidebarCollapsed(sidebar, sidebarToggleButton, chatSidebarCollapsed, SIDEBAR_COLLAPSED_KEY, 'sidebar');
            setSidebarCollapsed(pluginsSidebar, pluginsToggleButton, pluginSidebarCollapsed, PLUGINS_COLLAPSED_KEY, 'plugins');
            setPluginSectionCollapsed(filePluginHeader, filePluginContent, filePluginCollapsed, FILE_PLUGIN_COLLAPSED_KEY);
            setPluginSectionCollapsed(calendarPluginHeader, calendarPluginContent, calendarPluginCollapsed, CALENDAR_PLUGIN_COLLAPSED_KEY);
            // Set initial toggle state from localStorage
            isCalendarContextActive = localStorage.getItem('calendarContextActive') === 'true';
            calendarToggle.checked = isCalendarContextActive;
            updateCalendarStatus(); // Initial status update
            await loadSavedChats();
            await loadUploadedFiles();
            const firstChatElement = savedChatsList.querySelector('.list-item');
            if (firstChatElement) { const mostRecentChatId = parseInt(firstChatElement.dataset.chatId); await loadChat(mostRecentChatId); }
            else { await startNewChat(); }
            renderSelectedFiles();
        }

        // Start the application initialization process
        initializeApp();

    </script>
</body>
</html>
